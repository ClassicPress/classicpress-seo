(function(a){a.fn.tagEditor=function(b,c,f){function g(m){return m.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}var h,j=a.extend({},a.fn.tagEditor.defaults,b),k=this;if(j.dregex=new RegExp('['+j.delimiter.replace('-','-')+']','g'),'string'==typeof b){var l=[];return k.each(function(){var m=a(this),n=m.data('options'),p=m.next('.tag-editor');if('getTags'==b)l.push({field:m[0],editor:p,tags:p.data('tags')});else if('addTag'==b){if(n.maxTags&&p.data('tags').length>=n.maxTags)return!1;a('<li><div class="tag-editor-spacer">&nbsp;'+n.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(p).find('.tag-editor-tag').html('<input type="text" maxlength="'+n.maxLength+'">').addClass('active').find('input').val(c).blur(),f?a('.placeholder',p).remove():p.click()}else'removeTag'==b?(a('.tag-editor-tag',p).filter(function(){return a(this).text()==c}).closest('li').find('.tag-editor-delete').click(),f||p.click()):'clearTags'==b?a('li',p).find('.tag-editor-delete').click():'destroy'==b&&m.removeClass('tag-editor-hidden-src').removeData('options').off('focus.tag-editor').next('.tag-editor').remove()}),'getTags'==b?l:this}return window.getSelection&&a(document).off('keydown.tag-editor').on('keydown.tag-editor',function(m){if(8==m.which||46==m.which||m.ctrlKey&&88==m.which){try{var n=getSelection(),p='INPUT'==document.activeElement.tagName?0:a(n.getRangeAt(0).startContainer.parentNode).closest('.tag-editor')}catch(t){p=0}if(0<n.rangeCount&&p&&p.length){var q=[],r=n.toString().split(p.prev().data('options').dregex);for(i=0;i<r.length;i++){var s=a.trim(r[i]);s&&q.push(s)}return a('.tag-editor-tag',p).each(function(){~a.inArray(a(this).text(),q)&&a(this).closest('li').find('.tag-editor-delete').click()}),!1}}}),k.each(function(){function m(){!j.placeholder||t.length||a('.deleted, .placeholder, input',u).length||u.append('<li class="placeholder"><div>'+j.placeholder+'</div></li>')}function n(z){var A=t.toString();t=a('.tag-editor-tag:not(.deleted)',u).map(function(B,C){var D=a(this),E=a.trim(D.hasClass('active')?D.find('input').val():a(C).text());if(E)return E}).get(),u.data('tags',t),s.val(t.join(j.delimiter[0])),z||A==t.toString()||j.onChange(s,u,t),m(),z&&s.trigger('tag-editor-init',[u,t])}function p(z,A){return!1!==j.beforeTagDelete(z,u,t,A.text())&&(A.addClass('deleted').animate({width:0},j.animateDelete,function(){z.remove(),m()}),n(),!1)}function q(z){for(var F,A=z.closest('li'),B=z.val().replace(/ +/,' ').split(j.dregex),C=z.data('oldTag'),D=t.slice(0),E=!1,G=0;G<B.length;G++)if((y=a.trim(B[G]).slice(0,j.maxLength),j.forceLowercase&&(y=y.toLowerCase()),F=j.beforeTagSave(s,u,D,C,y),y=F||y,!1!==F&&y)&&(j.removeDuplicates&&~a.inArray(y,D)&&r(y),D.push(y),A.before('<li><div class="tag-editor-spacer">&nbsp;'+j.delimiter[0]+'</div><div class="tag-editor-tag">'+g(y)+'</div><div class="tag-editor-delete"><i></i></div></li>'),j.maxTags&&D.length>=j.maxTags)){E=!0;break}z.attr('maxlength',j.maxLength).removeData('oldTag').val(''),E?z.blur():z.focus(),n()}function r(z){a('.tag-editor-tag:not(.active)',u).each(function(){var A=a(this);A.text()==z&&A.closest('li').remove()})}var s=a(this),t=[],u=a('<ul '+(j.clickDelete?'oncontextmenu="return false;" ':'')+'class="tag-editor"></ul>').insertAfter(s);s.addClass('tag-editor-hidden-src').data('options',j).on('focus.tag-editor',function(){u.click()}),u.append('<li style="width:1px">&nbsp;</li>');var v='<li><div class="tag-editor-spacer">&nbsp;'+j.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';u.click(function(z,A){var B,C,D=99999;if(!(window.getSelection&&''!=getSelection()))return j.maxTags&&u.data('tags').length>=j.maxTags?(u.find('input').blur(),!1):(h=!0,a('input:focus',u).blur(),!!h)&&(h=!0,a('.placeholder',u).remove(),A&&A.length?C='before':a('.tag-editor-tag',u).each(function(){var E=a(this),F=E.offset(),G=F.left,H=F.top;z.pageY>=H&&z.pageY<=H+E.height()&&(z.pageX<G?(C='before',B=G-z.pageX):(C='after',B=z.pageX-G-E.width()),B<D&&(D=B,A=E))}),'before'==C?a(v).insertBefore(A.closest('li')).find('.tag-editor-tag').click():'after'==C?a(v).insertAfter(A.closest('li')).find('.tag-editor-tag').click():a(v).appendTo(u).find('.tag-editor-tag').click(),!1)}),u.on('click','.tag-editor-delete',function(){var A=a(this);if(A.prev().hasClass('active'))return A.closest('li').find('input').caret(-1),!1;var B=A.closest('li'),C=B.find('.tag-editor-tag');return p(B,C)}),j.clickDelete&&u.on('mousedown','.tag-editor-tag',function(z){if(z.ctrlKey||1<z.which){var A=a(this).closest('li'),B=A.find('.tag-editor-tag');return p(A,B)}}),u.on('click','.tag-editor-tag',function(z){var A=a(this);if(j.clickDelete&&(z.ctrlKey||1<z.which))return!1;if(!1===j.onSelect(A,u,t))return!1;if(!A.hasClass('active')){var B=A.text(),C=Math.abs((A.offset().left-z.pageX)/A.width()),D=parseInt(B.length*C),E=A.html('<input type="text" maxlength="'+j.maxLength+'" value="'+g(B)+'">').addClass('active').find('input');if(E.data('oldTag',B).focus().caret(D),j.autocomplete){var F=a.extend({},j.autocomplete),G='select'in F?j.autocomplete.select:'';F.select=function(H,I){G&&G(H,I),setTimeout(function(){u.trigger('click',[a('.active',u).find('input').closest('li').next('li').find('.tag-editor-tag')])},20)},E.autocomplete(F)}}return!1}),u.on('blur','input',function(z){z.stopPropagation();var D,A=a(this),B=A.data('oldTag'),C=a.trim(A.val().replace(/ +/,' ').replace(j.dregex,j.delimiter[0]));if(!C){if(B&&!1===j.beforeTagDelete(A.closest('li'),u,t,B))return A.val(B).focus(),h=!1,void n();try{A.closest('li').remove()}catch(E){}B&&n()}else{if(0<=C.indexOf(j.delimiter[0]))return void q(A);if(C!=B)if(j.forceLowercase&&(C=C.toLowerCase()),D=j.beforeTagSave(s,u,t,B,C),C=D||C,!1===D){if(B)return A.val(B).focus(),h=!1,void n();try{A.closest('li').remove()}catch(E){}B&&n()}else j.removeDuplicates&&r(C)}A.parent().html(g(C)).removeClass('active'),C!=B&&n(),m()}),u.on('paste','input',function(){a(this).removeAttr('maxlength');var A=a(this);setTimeout(function(){q(A)},30)}),u.on('keypress','input',function(z){if(0<=j.delimiter.indexOf(String.fromCharCode(z.which))){var A=a(this);setTimeout(function(){q(A)},20)}}),u.on('keydown','input',function(z){var A=a(this);if((37==z.which||!j.autocomplete&&38==z.which)&&!A.caret()||8==z.which&&!A.val()){var B=A.closest('li').prev('li').find('.tag-editor-tag');return B.length?B.click().find('input').caret(-1):A.val()&&!(j.maxTags&&u.data('tags').length>=j.maxTags)&&a(v).insertBefore(A.closest('li')).find('.tag-editor-tag').click(),!1}if((39==z.which||!j.autocomplete&&40==z.which)&&A.caret()==A.val().length){var C=A.closest('li').next('li').find('.tag-editor-tag');return C.length?C.click().find('input').caret(0):A.val()&&u.click(),!1}if(9==z.which){if(z.shiftKey){var B=A.closest('li').prev('li').find('.tag-editor-tag');if(B.length)B.click().find('input').caret(0);else if(A.val()&&!(j.maxTags&&u.data('tags').length>=j.maxTags))a(v).insertBefore(A.closest('li')).find('.tag-editor-tag').click();else return s.attr('disabled','disabled'),void setTimeout(function(){s.removeAttr('disabled')},30);return!1}var C=A.closest('li').next('li').find('.tag-editor-tag');if(C.length)C.click().find('input').caret(0);else if(A.val())u.click();else return;return!1}if(46==z.which&&(!a.trim(A.val())||A.caret()==A.val().length)){var C=A.closest('li').next('li').find('.tag-editor-tag');return C.length?C.click().find('input').caret(0):A.val()&&u.click(),!1}if(13==z.which)return u.trigger('click',[A.closest('li').next('li').find('.tag-editor-tag')]),j.maxTags&&u.data('tags').length>=j.maxTags&&u.find('input').blur(),!1;if(36==z.which&&!A.caret())u.find('.tag-editor-tag').first().click();else if(35==z.which&&A.caret()==A.val().length)u.find('.tag-editor-tag').last().click();else if(27==z.which)return A.val(A.data('oldTag')?A.data('oldTag'):'').blur(),!1});for(var y,w=j.initialTags.length?j.initialTags:s.val().split(j.dregex),x=0;x<w.length&&!(j.maxTags&&x>=j.maxTags);x++)y=a.trim(w[x].replace(/ +/,' ')),y&&(j.forceLowercase&&(y=y.toLowerCase()),t.push(y),u.append('<li><div class="tag-editor-spacer">&nbsp;'+j.delimiter[0]+'</div><div class="tag-editor-tag">'+g(y)+'</div><div class="tag-editor-delete"><i></i></div></li>'));n(!0),j.sortable&&a.fn.sortable&&u.sortable({distance:5,cancel:'.tag-editor-spacer, input',helper:'clone',update:function(){n()}})})},a.fn.tagEditor.defaults={initialTags:[],maxTags:classicSEO.maxTags,maxLength:250,delimiter:',;',placeholder:'',forceLowercase:!0,removeDuplicates:!0,clickDelete:!1,animateDelete:175,sortable:!0,autocomplete:null,onSelect:function(){return!0},onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}})(jQuery);